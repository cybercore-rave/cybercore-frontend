<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Reserve — cyber//core</title>
  <style>
    *,*::before,*::after{ box-sizing:border-box }
    html{ -webkit-text-size-adjust:100% }
    body{ margin:0; background:#000; color:#fff; font-family:Inter,Arial,sans-serif }

    .main{ padding:16px }
    .card{
      width:100%; max-width:640px; margin:24px auto; background:#0d0d0d;
      border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.6)
    }
    .logo-wrap{ text-align:center; margin-bottom:16px }
    .logo{ display:inline-block; width:min(70%,240px); height:auto }

    h2{ margin:0 0 16px }
    label{ display:block; margin-top:12px; font-size:14px; color:#cfcfcf }
    .req::after{ content:" *"; color:#ff6b6b }

    input,select{
      width:100%; padding:12px; border-radius:10px;
      border:1px solid #2f2f2f; background:#111; color:#fff
    }

    .price{ font-size:14px; color:#c4faf8; margin-top:6px; min-height:1em }

    button{
      width:100%; margin-top:16px; padding:12px 16px;
      border:0; border-radius:12px; background:#9800ff; color:#fff; font-weight:600;
      cursor:pointer; transition:transform .12s ease, filter .12s ease
    }
    button:hover{ transform:translateY(-1px); filter:brightness(1.1) }
    button:active{ transform:translateY(0); filter:brightness(0.95) }
    button[disabled]{ opacity:.6; cursor:not-allowed }

    /* Full-screen success overlay */
    .success {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,.92);
      display: none; align-items: center; justify-content: center;
      padding: 20px;
    }
    .success.show { display: flex; }
    .success .panel{
      background:#0d0d0d; width:min(96vw, 640px);
      border-radius:16px; padding:24px; text-align:center;
      box-shadow:0 12px 36px rgba(0,0,0,.7)
    }
    .success h2{ margin:6px 0 8px }
    .success p{ margin:6px 0; color:#cfcfcf }
    .kicker{ color:#c4faf8; letter-spacing:.05em; text-transform:uppercase; font-size:12px }
    .row{ margin-top:10px; font-size:14px; color:#ddd }
    .badge{
      display:inline-block; margin-top:10px; padding:6px 10px; border-radius:999px;
      background:#141414; border:1px solid #262626; font-size:12px; color:#bbb
    }
    .cta{
      margin-top:18px; display:inline-block; padding:12px 16px; border-radius:12px;
      background:#9800ff; color:#fff; text-decoration:none; font-weight:600
    }

    @media (max-width:900px){
      .main{ padding:8px }
      .card{ max-width:none; width:100%; margin:8px auto; border-radius:12px; padding:16px }
      input,select,button{ font-size:16px }
    }
  </style>
</head>
<body>
  <div class="main">
    <div class="card" id="formCard">
      <div class="logo-wrap"><img class="logo" src="logo.png" alt="cyber//core"></div>

      <h2>Reserve your tier</h2>

      <label class="req" for="name">Name</label>
      <input id="name" placeholder="Your name" autocomplete="name">

      <label class="req" for="email">Email</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email">

      <label for="tier">Tier</label>
      <select id="tier"></select>
      <div id="price" class="price"></div>

      <button id="submit" disabled>Reserve</button>
      <div id="msg" style="margin-top:12px; min-height:22px"></div>
    </div>
  </div>

  <!-- Success overlay -->
  <div class="success" id="success">
    <div class="panel">
      <img class="logo" src="logo.png" alt="cyber//core" style="width:180px;height:auto">
      <div class="kicker">Reservation confirmed</div>
      <h2>You're in — check your email for your QR code.</h2>

      <div id="successDetails" class="row"></div>
      <div id="successId" class="badge"></div>

      <a class="cta" href="https://instagram.com/cybercore.rave" target="_blank" rel="noopener">Event details</a>
    </div>
  </div>

  <script>
    // DOM refs
    const tierSel = document.getElementById('tier');
    const priceEl = document.getElementById('price');
    const nameEl  = document.getElementById('name');
    const emailEl = document.getElementById('email');
    const submit  = document.getElementById('submit');
    const msg     = document.getElementById('msg');
    const success = document.getElementById('success');
    const successDetails = document.getElementById('successDetails');
    const successId = document.getElementById('successId');
    const formCard = document.getElementById('formCard');

    let API = null;       // detected at runtime
    let tiers = [];       // cached tiers

    // Helpers
    function updatePrice(){
      const t = tiers.find(x => x.tier === tierSel.value);
      priceEl.textContent = t ? `Price: $${t.price} TTD` : '';
    }
    function updateButton(){
      const ok = nameEl.value.trim() && emailEl.validity.valid && tierSel.value;
      submit.disabled = !ok;
    }
    function showError(text){ msg.style.color = '#ff6b6b'; msg.textContent = text; }
    function showInfo(text){ msg.style.color = '#c4faf8'; msg.textContent = text; }

    // Detect /api or /api/proxy
    async function detectApiBase(){
      const candidates = ['/api', '/api/proxy'];
      for (const base of candidates){
        try{
          const r = await fetch(`${base}?endpoint=health`, { cache:'no-store' });
          const j = await r.json();
          if (j && j.ok) return base;
        }catch(e){}
      }
      return null;
    }

    async function loadTiers(){
      msg.textContent = '';
      const res = await fetch(`${API}?endpoint=tiers`, { cache:'no-store' });
      const json = await res.json();
      tiers = json.ok ? json.data : [];
      tierSel.innerHTML = '';
      if (!tiers.length){
        tierSel.innerHTML = '<option value="">All QR tiers sold out</option>';
        priceEl.textContent = '';
      } else {
        tiers.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.tier;
          opt.textContent = `${t.tier} — ${t.remaining} left`;
          tierSel.appendChild(opt);
        });
        updatePrice();
      }
      updateButton();
    }

    function showSuccess({ name, email, tier, price, reservationID }){
      // lock the form to avoid duplicates
      nameEl.disabled = true; emailEl.disabled = true; tierSel.disabled = true; submit.disabled = true;
      submit.textContent = 'Reserved';

      // fill overlay
      const priceText = (price != null) ? ` — $${price} TTD` : '';
      successDetails.textContent = `${name} • ${email} • ${tier}${priceText}`;
      successId.textContent = reservationID ? `Reservation ID: ${reservationID}` : '';
      success.classList.add('show');

      // ensure it’s visible
      success.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    async function reserve(){
      msg.textContent = ''; showInfo(''); // clear
      submit.disabled = true;
      const prev = submit.textContent;
      submit.textContent = 'Reserving…';

      try{
        const payload = {
          name: nameEl.value.trim(),
          email: emailEl.value.trim(),
          tier: tierSel.value
        };

        const res = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ endpoint: 'reserve', payload })
        });
        const json = await res.json();

        if (json.ok){
          // try to pull price for display
          const t = tiers.find(x => x.tier === payload.tier);
          showSuccess({
            name: payload.name,
            email: payload.email,
            tier: payload.tier,
            price: t ? t.price : undefined,
            reservationID: json.reservationID
          });
          // refresh tiers count in background
          loadTiers();
          return;
        }

        showError(json.error || 'Error, try again.');
      } catch (e){
        showError('Network error. Try again.');
        console.error('reserve error:', e);
      } finally {
        if (!success.classList.contains('show')) {
          submit.textContent = prev;
          updateButton();
        }
      }
    }

    // Wire up + boot
    async function init(){
      API = await detectApiBase();
      if (!API){ showError('API not reachable.'); return; }
      nameEl.addEventListener('input', updateButton);
      emailEl.addEventListener('input', updateButton);
      tierSel.addEventListener('change', () => { updatePrice(); updateButton(); });
      submit.addEventListener('click', reserve);
      await loadTiers();
    }
    init();
  </script>
</body>
</html>
