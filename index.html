<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Reserve — cyber//core</title>

  <!-- Favicon & OS meta -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <meta name="theme-color" content="#000000">

  <style>
    :root{
      --bg:#000;
      --card:#0d0d0d;
      --text:#fff;
      --muted:#cfcfcf;
      --primary:#9800ff;   /* cyber//core purple */
      --accent:#c4faf8;
      --border:#2f2f2f;
    }
    *,*::before,*::after{ box-sizing:border-box }
    html{ -webkit-text-size-adjust:100% }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:Inter,Arial,sans-serif }

    .main{ padding:16px }
    .card{
      width:100%; max-width:640px; margin:24px auto; background:var(--card);
      border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.6)
    }
    .logo-wrap{ text-align:center; margin-bottom:16px }
    .logo{ display:inline-block; width:min(70%,240px); height:auto }

    h2{ margin:0 0 16px }
    label{ display:block; margin-top:12px; font-size:14px; color:var(--muted) }
    .req::after{ content:" *"; color:#ff6b6b }

    input,select{
      width:100%; padding:12px; border-radius:10px;
      border:1px solid var(--border); background:#111; color:var(--text)
    }
    /* Price in purple */
    .price{ font-size:14px; color:var(--primary); margin-top:6px; min-height:1em }

    /* inline help + invalid styles */
    .help{ display:none; color:#ff6b6b; font-size:12px; margin-top:6px }
    .help.show{ display:block }
    input.invalid{ border-color:#ff6b6b; box-shadow:0 0 0 2px rgba(255,107,107,.12) inset }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      gap:.5rem; text-decoration:none; user-select:none;
      font-weight:600; border-radius:12px; padding:12px 16px; border:0; cursor:pointer;
      transition:transform .12s ease, filter .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
    }
    .btn-primary{ width:100%; background:var(--primary); color:#fff; }
    .btn-primary:hover{ transform:translateY(-1px); filter:brightness(1.1) }
    .btn-primary:active{ transform:translateY(0); filter:brightness(0.95) }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }

    /* Nudge the main Reserve button down a bit */
    #submit { margin-top: 24px; }
    @media (max-width: 900px){
      #submit { margin-top: 20px; }
    }

    /* Success overlay */
    .success {
      position: fixed; inset: 0; z-index: 1000;
      background: rgba(0,0,0,.92);
      display: none; align-items: center; justify-content: center;
      padding: 20px;
    }
    .success.show { display: flex; }
    .success .panel{
      background:var(--card); width:min(96vw, 760px);
      border-radius:20px; padding:28px; text-align:center;
      box-shadow:0 18px 60px rgba(0,0,0,.7)
    }
    .success .kicker{ color:#9aa; letter-spacing:.08em; font-size:12px; text-transform:uppercase; margin-top:6px }
    .success h1{ margin:12px 0 14px; font-size:clamp(22px,3.6vw,36px) }
    .row{ margin:10px 0 2px; font-size:15px; color:#ddd }
    .badge{
      display:inline-block; margin:12px 0 0; padding:8px 12px; border-radius:999px;
      background:#141414; border:1px solid #262626; font-size:12px; color:#bbb
    }
    .actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top:18px }
    .btn-ghost{
      background:transparent; color:#fff; border:1px solid var(--primary);
      padding:12px 16px; border-radius:12px;
    }
    .btn-ghost:hover{ background:rgba(152,0,255,.12) }

    /* tiny link-style button */
    .link-btn{
      background:transparent; border:0; color:var(--accent);
      text-decoration:underline; font-size:12px; padding:0; margin-top:6px; cursor:pointer;
    }
    .link-btn[disabled]{
      opacity:.6;
      cursor:wait;
      text-decoration:none;
      pointer-events:none;
    }
    @media (max-width:900px){
      .main{ padding:8px }
      .card{ max-width:none; width:100%; margin:8px auto; border-radius:12px; padding:16px }
      input,select,.btn{ font-size:16px }
      .actions .btn{ width:100% } /* stack buttons on mobile */
    }

    /* Paused visual cue (optional dim) */
    .paused { opacity:.75; filter:saturate(.85); }
  </style>
</head>
<body>
  <div class="main">
    <div class="card" id="formCard">
      <div class="logo-wrap"><img class="logo" src="logo.png" alt="cyber//core"></div>

      <h2>Reserve your tier</h2>

      <!-- pause banner -->
      <div id="pause" style="display:none; margin:8px 0 12px; padding:10px 12px; background:#141414; border:1px solid #262626; border-left:4px solid #9800ff; color:#ddd; border-radius:10px;">
        Reservations are temporarily paused. Please check back soon.
      </div>

      <fieldset id="fields" style="border:0; padding:0; margin:0;">
        <label class="req" for="name">Name</label>
        <input id="name" placeholder="Your name" autocomplete="name" required>

        <label class="req" for="email">Email</label>
        <input id="email" type="email" required
               placeholder="you@example.com" autocomplete="email"
               pattern="^[A-Za-z0-9.!#$%&'*+/=?^_`{|}~-]+@[A-Za-z0-9-]+(?:\\.[A-Za-z0-9-]+)+$">
        <div id="emailHelp" class="help">Please enter a valid email address.</div>

        <label for="tier">Tier</label>
        <select id="tier"></select>
        <div id="price" class="price"></div>
        <button id="refresh" class="link-btn" style="display:none" type="button">Refresh availability</button>

        <button id="submit" class="btn btn-primary" disabled>Reserve</button>
      </fieldset>

      <div id="msg" style="margin-top:12px; min-height:22px"></div>
    </div>
  </div>

  <!-- Success overlay -->
  <div class="success" id="success">
    <div class="panel">
      <img class="logo" src="logo.png" alt="cyber//core" style="width:180px;height:auto">
      <div class="kicker">Reservation confirmed</div>
      <h1>You're in — check your email for your QR code.</h1>

      <div id="successDetails" class="row"></div>
      <div id="successId" class="badge"></div>

      <div class="actions">
        <button id="again" class="btn btn-primary">Book another ticket</button>
        <a class="btn btn-ghost" href="https://instagram.com/cybercore.rave" target="_blank" rel="noopener">Event details</a>
      </div>
    </div>
  </div>

  <script>
    /* ----------------- DOM refs ----------------- */
    const tierSel = document.getElementById('tier');
    const priceEl = document.getElementById('price');
    const nameEl  = document.getElementById('name');
    const emailEl = document.getElementById('email');
    const emailHelp = document.getElementById('emailHelp');
    const submit  = document.getElementById('submit');
    const msg     = document.getElementById('msg');
    const success = document.getElementById('success');
    const successDetails = document.getElementById('successDetails');
    const successId = document.getElementById('successId');
    const againBtn = document.getElementById('again');
    const fieldsFs = document.getElementById('fields');
    const pauseBanner = document.getElementById('pause');
    const refreshBtn  = document.getElementById('refresh');

    /* ----------------- State ----------------- */
    let API = null;      // '/api' base for POST
    let tiers = [];      // current tiers
    let lowStock = false;
    let tiersRequestAbort = null; // AbortController for in-flight fetch

    /* ----------------- Helpers ----------------- */
    function updatePrice(){
      const t = tiers.find(x => x.tier === tierSel.value);
      priceEl.textContent = t ? `Price: $${t.price} TTD` : '';
    }
    function updateButton(){
      const ok = !fieldsFs.disabled && nameEl.value.trim() && emailEl.validity.valid && tierSel.value;
      submit.disabled = !ok;
    }
    function showError(text){ msg.style.color = '#ff6b6b'; msg.textContent = text; }
    function showInfo(text){ msg.style.color = '#c4faf8'; msg.textContent = text; }

    function validateEmail(){
      if (!emailEl.value.trim()){
        emailEl.classList.remove('invalid');
        emailHelp.classList.remove('show');
        return;
      }
      if (emailEl.validity.valid){
        emailEl.classList.remove('invalid');
        emailHelp.classList.remove('show');
      } else {
        emailEl.classList.add('invalid');
        emailHelp.classList.add('show');
      }
    }

    /* ----------------- Status banner ----------------- */
    function enforceStatus(open){
      if (!open){
        pauseBanner.style.display = 'block';
        fieldsFs.disabled = true;
        document.getElementById('formCard').classList.add('paused');
        submit.disabled = true;
      } else {
        pauseBanner.style.display = 'none';
        fieldsFs.disabled = false;
        document.getElementById('formCard').classList.remove('paused');
        updateButton();
      }
    }

    async function checkStatus(){
      try {
        const r = await fetch(`/api/status?_=${Date.now()}`, { cache:'no-store' });
        const j = await r.json();
        enforceStatus(j.ok ? !!j.open : true);
      } catch (_) {
        enforceStatus(true);
      }
    }

    /* ----------------- API base for POST ----------------- */
    async function detectApiBase(){
      const bases = ['/api', '/api/index'];
      for (const base of bases){
        try{
          const r = await fetch(`/api/tiers?_=${Date.now()}`, { cache:'no-store' });
          const j = await r.json().catch(()=>null);
          if (j && j.ok) { console.log('Using API base:', base); return base; }
        }catch(e){}
      }
      console.error('No API base detected.');
      return null;
    }

    /* ----------------- Render tiers ----------------- */
    function renderTiers(data){
      tiers = Array.isArray(data) ? data : [];
      tierSel.innerHTML = '';
      if (!tiers.length){
        tierSel.innerHTML = '<option value="">All QR tiers sold out</option>';
        priceEl.textContent = '';
        lowStock = false;
      } else {
        for (const t of tiers){
          const opt = document.createElement('option');
          opt.value = t.tier;
          opt.textContent = `${t.tier} — ${t.remaining} left`;
          tierSel.appendChild(opt);
        }
        updatePrice();
        lowStock = tiers.some(t => t.remaining <= 5);
      }
      refreshBtn.style.display = lowStock ? 'inline' : 'none';
      tierSel.disabled = false;
      updateButton();
      msg.textContent = '';
    }

    /* ----------------- Load tiers (always fresh + race-safe) ----------------- */
    async function loadTiers({ fromRefresh = false } = {}) {
      // visual feedback on the refresh link
      if (fromRefresh) {
        refreshBtn.dataset.prev = refreshBtn.textContent || 'Refresh availability';
        refreshBtn.textContent = 'Refreshing…';
        refreshBtn.setAttribute('disabled', 'true');
        refreshBtn.setAttribute('aria-busy', 'true');
      }

      // cancel any in-flight request to prevent race conditions
      if (tiersRequestAbort) {
        try { tiersRequestAbort.abort(); } catch (_) {}
      }
      tiersRequestAbort = new AbortController();

      // show loading state in the dropdown
      tierSel.disabled = true;
      tierSel.innerHTML = '<option disabled selected>Loading tiers…</option>';
      priceEl.textContent = '';
      updateButton();

      try {
        const buster = Date.now(); // defeat any intermediary caching
        const res = await fetch(`/api/tiers?_=${buster}`, {
          cache: 'no-store',
          signal: tiersRequestAbort.signal,
        });
        const json = await res.json();
        if (!json.ok || !Array.isArray(json.data)) throw new Error(json.error || 'Bad response');

        renderTiers(json.data);
      } catch (e) {
        if (e.name === 'AbortError') return; // an explicit cancel; ignore
        console.error('loadTiers error:', e);
        tierSel.disabled = false;
        tierSel.innerHTML = '<option disabled selected>Could not load. Tap to retry.</option>';
        const retry = () => { tierSel.removeEventListener('click', retry); loadTiers(); };
        tierSel.addEventListener('click', retry, { once: true });
        showError('Could not load tiers. Tap the dropdown to retry.');
      } finally {
        if (fromRefresh) {
          refreshBtn.textContent = refreshBtn.dataset.prev || 'Refresh availability';
          refreshBtn.removeAttribute('disabled');
          refreshBtn.removeAttribute('aria-busy');
        }
        tiersRequestAbort = null;
      }
    }

    /* ----------------- Success / reset ----------------- */
    function showSuccess({ name, email, tier, price, reservationID }){
      fieldsFs.disabled = true;
      submit.disabled = true;
      submit.textContent = 'Reserved';

      const priceText = (price != null) ? ` — $${price} TTD` : '';
      successDetails.textContent = `${name} • ${email} • ${tier}${priceText}`;
      successId.textContent = reservationID ? `Reservation ID: ${reservationID}` : '';
      success.classList.add('show');
    }

    function resetForm(){
      success.classList.remove('show');
      fieldsFs.disabled = false;
      nameEl.value = ''; emailEl.value = ''; emailEl.classList.remove('invalid'); emailHelp.classList.remove('show');
      if (tierSel.options.length) tierSel.selectedIndex = 0;
      submit.textContent = 'Reserve';
      updatePrice(); updateButton();
      loadTiers();
      nameEl.focus({ preventScroll:false });
    }

    /* ----------------- Reserve ----------------- */
    async function reserve(){
      msg.textContent = ''; showInfo('');
      submit.disabled = true;
      const prev = submit.textContent;
      submit.textContent = 'Reserving…';

      try{
        const payload = {
          name: nameEl.value.trim(),
          email: emailEl.value.trim(),
          tier: tierSel.value
        };

        const res = await fetch(API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ endpoint: 'reserve', payload })
        });
        const json = await res.json();

        if (json.ok){
          const t = tiers.find(x => x.tier === payload.tier);
          showSuccess({
            name: payload.name,
            email: payload.email,
            tier: payload.tier,
            price: t ? t.price : undefined,
            reservationID: json.reservationID
          });
          loadTiers(); // refresh availability behind the overlay
          return;
        }

        showError(json.error || 'Error, try again.');
      } catch (e){
        showError('Network error. Try again.');
        console.error('reserve error:', e);
      } finally {
        if (!success.classList.contains('show')) {
          submit.textContent = prev;
          updateButton();
        }
      }
    }

    /* ----------------- Boot ----------------- */
    async function init(){
      API = await detectApiBase();
      if (!API){ showError('API not reachable.'); return; }

      nameEl.addEventListener('input', updateButton);
      emailEl.addEventListener('input', () => { validateEmail(); updateButton(); });
      emailEl.addEventListener('blur',  validateEmail);
      tierSel.addEventListener('change', () => { updatePrice(); updateButton(); });
      submit.addEventListener('click', reserve);
      againBtn.addEventListener('click', resetForm);
      refreshBtn.addEventListener('click', () => loadTiers({ fromRefresh: true }));
      window.addEventListener('focus', () => loadTiers()); // optional: refresh when user refocuses

      await checkStatus();
      await loadTiers();
    }

    init();
  </script>
</body>
</html>
